<!DOCTYPE html>
<html lang="en">
    <head>
        <title><%= title %></title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="/css/style.css">
    </head>
    <body>
        <%- include("common/nav.ejs", { user }); %>
        <div class="content">
            <div class="m-2">
                <h1>Opening <%=boxes.filter(box => box.id === parseInt(boxId))[0].name%></h1>
                <div class="hidden" id="vukkyData">
                    <%- include("common/vukky.ejs"); %>
                </div>
                <br>
                <button onclick="openBox()" class="btn">Open</button>
                <button onclick="share()" id="shareButton" class="btn hidden">Share drop</button>

            </div>
        </div>
        <script>
            let shareUrl = "";
            const rarityLang = {
	            "common": "<%=lang.vukkies.common%>",
	            "uncommon": "<%=lang.vukkies.uncommon%>",
	            "rare": "<%=lang.vukkies.common%>",
	            "mythical": "<%=lang.vukkies.mythical%>",
	            "godly": "<%=lang.vukkies.godly%>",
	            "bukky": "<%=lang.vukkies.bukky%>",
	            "unique": "<%=lang.vukkies.unique%>",
	            "pukky": "<%=lang.vukkies.pukky%>",
            }

			const rarityColor = {
				"common": "<%=rarity.common.color%>",
				"uncommon": "<%=rarity.uncommon.color%>",
				"rare": "<%=rarity.rare.color%>",
				"mythical": "<%=rarity.mythical.color%>",
				"godly": "<%=rarity.godly.color%>",
				"bukky": "<%=rarity.bukky.color%>",
				"unique": "<%=rarity.unique.color%>",
				"pukky": "<%=rarity.pukky.color%>",
            }

            function openBox() {
	            document.getElementById("vukkyData").classList.add("hidden");
	            document.getElementById("shareButton").classList.add("hidden");
	            fetch("/api/internal/open/<%=boxId%>", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({})
                })
		            .then(res => res.json())
		            .then(data => {
						if (data.error) {
							return alert(data.error);
                        }
                        document.getElementById("balance").textContent = data.newBalance;
			            document.getElementById("vukkyName").innerHTML = data.vukky.name;
						document.getElementById("vukkyImage").src = data.vukky.imageURL;
			            document.getElementById("vukkyRarity").innerHTML = rarityLang[data.vukky.rarity];
			            document.getElementById("vukkyCreator").innerHTML = `Created by ${data.vukky.creator ? data.vukky.creator : "Unknown"}`;
			            document.getElementById("vukkyDescription").innerHTML = data.vukky.description;
						document.getElementById("vukkyCard").style.borderColor = rarityColor[data.vukky.rarity];
			            document.getElementById("vukkyData").classList.remove("hidden");
			            document.getElementById("shareButton").classList.remove("hidden");
						shareUrl = `${window.location.origin}/event/${data.eventId}`;
		            });
            }

			function share() {
				navigator.clipboard.writeText(shareUrl);
				alert("Link copied to clipboard!");
            }
        </script>
        <%- include("common/footer.ejs", { user }); %>
    </body>
</html>